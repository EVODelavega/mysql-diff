# MySQL diff tool

This tool enables you to automatically generate the queries you need to alter an outdated schema to more closely resemble another version.
If you have, for example, an old DB dump that you want to use, but the DB schema has been changed too much for your application to use it, you can import the old dump into a new database, and then use this tool to add missing tables, indexes and alter column definitions where needed.

## How to use

It's a simple CLI tool. To set it up, simply run `composer install -o` in the project root. To run the tool, execute the command.php tool: `./command.php db:diff -h`
The output of the help message should be enough to work out how to use the tool, but still: the typical command you'll use to generate the queries would look something like this:

```bash
./command.php -H localhost -u dbuser -p dbpass -b old_schema -t new_schema -c -a
# or
./command.php --host=localhost --username=dbuser --password=dbpass --base=old_schema --target=new_schema --alter --create
```

The output will be a series of queries that update the `old_schema` DB to more closely resemble the `new_schema` layout. Queries to drop tables that are no longer in use can also be generated by adding the `--drop` flag (or `-d` for short).

When generating `--alter` queries, you can add the `-F` or `--fks` flag to have the tool check foreign key constraints. If an existing foreign key uses a different field in the target schema, this is seen as an indication of a field being renamed. Instead of adding the field using `ADD COLUMN`, a `CHANGE COLUMN` line will be added, using the field definition found in the new schema.

By default, columns that exist in the old schema, but not in the new one are left as they are. If you want to delete old fields, you can use the `--purge` or `-P` flag to add `DROP COLUMN` lines to the output.
Tables that are no longer part of the target schema are also left alone, but there's a `--drop` (`-d`) flag to generate `DROP TABLE` queries, too.

### How it works

Basically, the tool sets about fetching all of the table names that make up the target schema. One by one, it then checks to see if the base schema has a table with the same name. If not, the create statement from the target schema is added to the list of queries. If it does, both create statements are parsed, and the parts that make up the table are compared in the following order:

- Foreign keys (if `-F` flag was passed)
- Missing fields
- Redundant fields (if `-P` flag was passed)
- Primary keys (compared/added/dropped if needed)
- Indexes (add missing indexes, or redefine existing ones)

Next up, tables that are not found in the target schema are dropped


